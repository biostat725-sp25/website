{
  "hash": "9dcea4a81d1718ce083076e152887fe7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"AE 04: Priors in Stan\"\nsubtitle: \"Modeling diabetes disease progression\"\ndate: \"Jan 23, 2025\"\n---\n\n\n\n::: callout-important\n## Due date\n\nApplication exercises (AEs) are submitted by pushing your work to the relevant GitHub repo. AEs from Tuesday lectures should be submitted by Friday by 11:59pm ET, and AEs from Thursday lectures should be submitted by Sunday at 11:59pm ET. Because AEs are intended for in-class activities, there are no extensions given on AEs.\n\n-   Final `.qmd` and `.pdf` files pushed to your GitHub repo\n-   **Note:** For homeworks and exams, you will also be required to submit your final `.pdf` file submitted on Gradescope\n:::\n\n# Introduction\n\nThis AE will take another look at the diabetes regression problem from Tuesday. At the end of the AE, we realized that placing priors on the parameters yields incorrect posterior inference. During this AE we will explore data centering approaches to stabilize our Bayesian model and explore the implications of prior specification.  \n\n## Learning goals\n\nBy the end of the AE, you will...\n\n-   Understand the idea of centering data for stabilizing inference\n-   Gain knowledge on prior specification and its sometimes unintended impact\n-   Be able to compute and interpret a posterior predictive distribution\n\n# Getting Started\n\n## Clone the repo & start new RStudio project\n\n-   Go to the course organization at [github.com/biostat725-sp25](https://github.com/biostat725-sp25) organization on GitHub.\n-   Click on the repo with the prefix **ae-04-**. It contains the starter documents you need to complete the AE.\n-   Click on the green **CODE** button, select **Use SSH** (this might already be selected by default, and if it is, you'll see the text **Clone with SSH**). Click on the clipboard icon to copy the repo URL.\n    -   See the [HW 00 instructions](https://biostat725-sp25.netlify.app/hw/hw-00#connect-rstudio-and-github) if you have not set up the SSH key or configured git.\n-   In RStudio, go to *File* $\\rightarrow$ *New Project* $\\rightarrow$ *Version Control* $\\rightarrow$ *Git*.\n-   Copy and paste the URL of your assignment repo into the dialog box *Repository URL*. Again, please make sure to have *SSH* highlighted under *Clone* when you copy the address.\n-   Click *Create Project*, and the files from your GitHub repo will be displayed in the *Files* pane in RStudio.\n-   Click `AE 04.qmd` to open the template Quarto file. This is where you will write up your code and narrative for the AE.\n\n# R packages\n\nWe will begin by loading R packages that we will use in this AE.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)    # data wrangling and visualization\nlibrary(knitr)        # format output\nlibrary(rstan)        # Stan\nlibrary(bayesplot)    # figures for post Stan inference\n```\n:::\n\n\n\n# Data\n\nToday we will use data from the paper [Least Angle Regression](https://projecteuclid.org/journals/annals-of-statistics/volume-32/issue-2/Least-angle-regression/10.1214/009053604000000067.full) by Efron et al. There are ten baseline variables, age, sex, body mass index, average blood pressure, and six blood serum measurements were obtained for each of n = 442 diabetes patients, as well as the response of interest, a quantitative measure of disease progression one year after baseline.\n\nWe will focus on the following variables:\n\n-   `Y`: measure of disease progression one year after baseline\n\n-   `AGE`: age in years\n\n-   `SEX`: sex (`1` = female, `2` = male)\n\n-   `BMI`: body mass index ($kg/m^2$)\n\n-   `BP`: average blood pressure (mm Hg)\n\nThe goal of this analysis is to learn the associations between age, sex, BMI, and blood pressure on diabetic disease progression one year after baseline. The data is available in the `ae-04-` repo and is called `diabetes.txt`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndiabetes <- read_table(\"diabetes.txt\")\nglimpse(diabetes)\n```\n:::\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 442\nColumns: 11\n$ AGE <dbl> 59, 48, 72, 24, 50, 23, 36, 66, 60, 29, 22, 56, 53, 50, 61, 34, 47…\n$ SEX <dbl> 2, 1, 2, 1, 1, 1, 2, 2, 2, 1, 1, 2, 1, 2, 1, 2, 1, 2, 1, 1, 1, 2, …\n$ BMI <dbl> 32.1, 21.6, 30.5, 25.3, 23.0, 22.6, 22.0, 26.2, 32.1, 30.0, 18.6, …\n$ BP  <dbl> 101.00, 87.00, 93.00, 84.00, 101.00, 89.00, 90.00, 114.00, 83.00, …\n$ S1  <dbl> 157, 183, 156, 198, 192, 139, 160, 255, 179, 180, 114, 184, 186, 1…\n$ S2  <dbl> 93.2, 103.2, 93.6, 131.4, 125.4, 64.8, 99.6, 185.0, 119.4, 93.4, 5…\n$ S3  <dbl> 38, 70, 41, 40, 52, 61, 50, 56, 42, 43, 46, 32, 62, 49, 72, 39, 70…\n$ S4  <dbl> 4.00, 3.00, 4.00, 5.00, 4.00, 2.00, 3.00, 4.55, 4.00, 4.00, 2.00, …\n$ S5  <dbl> 4.8598, 3.8918, 4.6728, 4.8903, 4.2905, 4.1897, 3.9512, 4.2485, 4.…\n$ S6  <dbl> 87, 69, 85, 89, 80, 68, 82, 92, 94, 88, 83, 77, 81, 88, 73, 81, 98…\n$ Y   <dbl> 151, 75, 141, 206, 135, 97, 138, 63, 110, 310, 101, 69, 179, 185, …\n```\n\n\n:::\n:::\n\n\n\n# Review of last AE\n\nLast AE we fit the following model in Stan and presented posterior summaries.\n\n$$\nY_i = \\alpha + \\mathbf{x}_i\\boldsymbol{\\beta} + \\epsilon_i, \\hspace{5mm} \\epsilon \\sim N(0, \\sigma^2),\n$$ where $\\mathbf{x}_i = (Age_i, 1(Sex_i = Male), BMI_i, BP_i)$ and flat priors for all parameters: $f(\\alpha,\\boldsymbol{\\beta},\\sigma) \\propto c.$ Flat priors are specified by default, so we can omit any prior specification.\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nInference for Stan model: anon_model.\n4 chains, each with iter=2000; warmup=1000; thin=1; \npost-warmup draws per chain=1000, total post-warmup draws=4000.\n\n            mean se_mean    sd     2.5%    97.5% n_eff Rhat\nalpha    -209.90    0.40 22.78  -254.86  -164.14  3269    1\nbeta[1]     0.14    0.00  0.24    -0.34     0.62  3596    1\nbeta[2]   -10.20    0.10  6.04   -21.85     1.62  3559    1\nbeta[3]     8.49    0.01  0.71     7.10     9.86  3515    1\nbeta[4]     1.44    0.00  0.24     0.97     1.90  3286    1\nsigma      60.18    0.03  2.05    56.26    64.51  3572    1\nlp__    -2433.14    0.04  1.82 -2437.76 -2430.69  1686    1\n\nSamples were drawn using NUTS(diag_e) at Tue Jan 21 09:52:22 2025.\nFor each parameter, n_eff is a crude measure of effective sample size,\nand Rhat is the potential scale reduction factor on split chains (at \nconvergence, Rhat=1).\n```\n\n\n:::\n:::\n\n\n\nThe Bayesian regression results nicely matched the OLS/MLE results.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lm(Y ~ AGE + as.factor(SEX) + BMI + BP, data = diabetes))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = Y ~ AGE + as.factor(SEX) + BMI + BP, data = diabetes)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-152.417  -43.576   -3.757   42.938  150.054 \n\nCoefficients:\n                 Estimate Std. Error t value Pr(>|t|)    \n(Intercept)     -209.2284    22.6318  -9.245  < 2e-16 ***\nAGE                0.1353     0.2329   0.581    0.562    \nas.factor(SEX)2  -10.1590     5.9219  -1.716    0.087 .  \nBMI                8.4843     0.7051  12.032  < 2e-16 ***\nBP                 1.4345     0.2393   5.996 4.25e-09 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 59.98 on 437 degrees of freedom\nMultiple R-squared:  0.4003,\tAdjusted R-squared:  0.3948 \nF-statistic: 72.91 on 4 and 437 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n:::\n\n\n\nHowever, when we changed the priors to the following, our regression results become extremely different from the OLS/MLE.\n\n\\begin{align*}\n\\alpha &\\sim N(0,10)\\\\\n\\beta_j &\\sim N(0,10),\\quad j=1,\\ldots,p\\\\\n\\sigma^2 &\\sim \\text{Inv-Gamma}(3,1).\n\\end{align*}\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nInference for Stan model: anon_model.\n4 chains, each with iter=2000; warmup=1000; thin=1; \npost-warmup draws per chain=1000, total post-warmup draws=4000.\n\n            mean se_mean     sd     2.5%    97.5% n_eff Rhat\nalpha     -30.80    0.16   9.36   -49.31   -12.71  3334    1\nbeta[1]    -0.19    0.00   0.25    -0.67     0.28  2799    1\nbeta[2]    -3.80    0.09   5.26   -13.90     7.03  3495    1\nbeta[3]     6.02    0.01   0.69     4.69     7.42  2137    1\nbeta[4]     0.40    0.00   0.22    -0.03     0.81  1994    1\nsigma2   4059.46    5.06 285.52  3519.71  4638.19  3186    1\nlp__    -2513.32    0.04   1.71 -2517.44 -2510.95  1764    1\n\nSamples were drawn using NUTS(diag_e) at Tue Jan 21 09:53:05 2025.\nFor each parameter, n_eff is a crude measure of effective sample size,\nand Rhat is the potential scale reduction factor on split chains (at \nconvergence, Rhat=1).\n```\n\n\n:::\n:::\n\n\n\n# Centering Data for Stable Inference\n\nBefore fitting our regression model, we will center the data. Define, $\\bar{Y} = \\frac{1}{n}\\sum_{i=1}^n Y_i$ and $\\bar{\\mathbf{x}}_i = \\frac{1}{n}\\sum_{i=1}^n \\mathbf{x}_i$. Then the centered data are $Y_i^* = Y_i - \\bar{Y}$ and $\\mathbf{x}_i^* = \\mathbf{x}_i - \\bar{\\mathbf{x}}_i$. We will then perform regression using the centered data, such that \n$$Y^*_i = \\alpha + \\mathbf{x}_i^*\\boldsymbol{\\beta} + \\epsilon_i, \\hspace{5mm} \\epsilon \\sim N(0, \\sigma^2).$$\nCentering our data can stabilize the posterior inference, because the data will be closer to zero. In particular, consider the scenario above where we placed a prior on $\\alpha \\sim N(0,10)$. We know that the true value of $\\alpha$ (according to OLS/MLE) is close to -200, so our prior, which was intended to be weakly-informative, is actually very strongly pulling the posterior towards zero. This then leads to a domino-effect, where the incorrect inference for $\\alpha$ will actually lead to unstable inference for the other parameters. Thus, centering our data means that $\\alpha$ should be close to 0, leading to stable inference for all of our parameters.\n\nEven though we fit the model on centered data, we are still able to recover the parameters on the scale of our original data.\n\n\\begin{align*}\n\\mathbb{E}[Y_i^* | \\alpha, \\boldsymbol{\\beta}] &= \\alpha + \\mathbf{x}_i^*\\boldsymbol{\\beta}\\\\\n\\mathbb{E}[Y_i - \\bar{Y} | \\alpha, \\boldsymbol{\\beta}] &= \\alpha + (\\mathbf{x}_i - \\bar{\\mathbf{x}}_i)\\boldsymbol{\\beta}\\\\\n\\mathbb{E}[Y_i | \\alpha, \\boldsymbol{\\beta}] &= \\bar{Y} + \\alpha - \\bar{\\mathbf{x}}_i\\boldsymbol{\\beta} + \\mathbf{x}_i\\boldsymbol{\\beta}\\\\\n\\mathbb{E}[Y_i | \\alpha, \\boldsymbol{\\beta}] &= \\alpha^* + \\mathbf{x}_i\\boldsymbol{\\beta},\n\\end{align*}\nwhere $\\alpha^* = \\bar{Y} + \\alpha - \\bar{\\mathbf{x}}_i\\boldsymbol{\\beta}$. Thus, on the original scale of the data the intercept would be equivalent to $\\alpha^*$. The regression slopes $\\boldsymbol{\\beta}$ do not need any transformation and can be interpreted on the original scale. The error term, $\\sigma^2$, can also be interpreted on the original scale, because $\\mathbb{V}(Y_i^* | \\alpha, \\boldsymbol{\\beta}) = \\sigma^2$.\n\n# Exercises\n\n## Exercise 1\n\nFit the centered regression model detailed above with the following priors: $\\alpha \\sim N(0,10)$, $\\beta_j \\sim N(0,10)$, and $\\sigma^2 \\sim \\text{Inv-Gamma}(3,1).$ Obtain posterior samples for this model using Stan. Be sure to present posterior samples for $\\alpha^*$.\n\n**Answer:**\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# add code here\n```\n:::\n\n\n\n## Exercise 2\n\nStan is extremely flexible in terms of the priors that can be used for parameters. Using the centered data specification, change the priors for all three parameters. Report how sensitive the results are. \n\n**Answer:**\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# add code here\n```\n:::\n\n\n\n## Exercise 3\n\nCompute a one-sided Bayesian p-value for the regression slope: $P(\\beta_1 < 0)$. Interpret the results in plain English. Is intraocular pressure associated with disease progression?\n\n**Answer:**\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# add code here\n```\n:::\n\n\n\n::: callout-important\nTo submit the AE:\n\n-   Render the document to produce the PDF with all of your work from today's class.\n-   Push all your work to your AE repo on GitHub. You're done! 🎉\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}